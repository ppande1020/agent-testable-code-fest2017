#!/usr/bin/env groovy

def passed = false

try 
{
	properties([parameters([string(defaultValue: 'debug', description: 'Type of build: release or debug', name: 'buildType'),])])
	def type = params.buildType
	
node('master') {

         def location = ".\\RelativityAgent1\\RelativityAgent.sln"
        
		
        stage('Stage Checkout') {	  
                checkout([$class: 'GitSCM', 
                branches: [[name: 'master']], 
                doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], 
                userRemoteConfigs: [[url: 'https://github.com/relativitydev/agent-testable-code-fest2017.git']]])
				bat 'echo checkout complete'
    
        }
		
		bat 'echo before utilites'
		def	utilites = load ("Utilities.groovy")
		bat 'echo after utilites'
		
        stage('Stage build'){
                fileExists location
				
				bat 'echo build command starting'
				echo location
			    echo type
				bat "powershell.exe \"& {.\\build.ps1 Compile -configuration ${type};exit \$lastexitcode}\""
			    bat 'echo build command done'
        }
		stage('Stage Unit Test'){
				bat "powershell.exe \"& {.\\build.ps1 UnitTest}\""
       }
	   stage('Stage Integration Test'){
				bat "powershell.exe \"& {.\\build.ps1 IntegrationTest}\""
       }
	   }
}
	   
finally
{
	if (!passed) 
	{
		mail (
			subject: "FAILURE: Job '${env.JOB_NAME}'",
			body: "FAILURE: Job '${env.JOB_NAME}': Check console output at ${env.BUILD_URL}",
			to: 'priyanka.pande@relativity.com'
		)
	}
	if (passed) 
	{
		
	}
}

	   
	   
